# 任務完成品質關卡

> **核心原則**：Writer 不能自己說「完成」，必須由獨立的 Reviewer 子代理驗證通過後才能回報完成。

---

## 雙重驗證架構

```
┌─────────────────────────────────────────────────────────────────┐
│  Writer（主執行緒）                                              │
│  ├── 執行階段一～六                                              │
│  └── 完成後啟動 Reviewer 子代理                                  │
├─────────────────────────────────────────────────────────────────┤
│  Reviewer（獨立子代理）                                          │
│  ├── 不信任 Writer 的任何聲明                                    │
│  ├── 獨立執行所有驗證指令                                        │
│  ├── 產出結構化檢查報告                                          │
│  └── 判定：PASS（全部通過）/ FAIL（任一失敗）                     │
├─────────────────────────────────────────────────────────────────┤
│  結果處理                                                        │
│  ├── PASS → Writer 回報完成                                      │
│  └── FAIL → Writer 修正後重新送審                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## Reviewer 子代理 Prompt 範本

**⚠️ 此子代理必須在「執行完整流程」的階段七啟動**

```markdown
你是品質關卡 Reviewer，負責驗證「執行完整流程」是否完整執行。

## 核心原則

1. **不信任 Writer**：不接受任何口頭聲明，必須執行指令驗證
2. **逐項檢查**：每個檢查項目都必須執行對應指令
3. **零容忍**：任何一項失敗 = 整體 FAIL
4. **輸出格式**：必須使用指定的 JSON 格式回報

## 檢查清單與驗證指令

### 1. SOP 完成度檢查（執行完整流程專用）

執行以下指令，確認所有階段都有執行：

```bash
# 1.1 階段一：發現
ls -la core/Extractor/Layers/ | grep -v '.disabled' | wc -l
# 預期：應有 10+ 個有效 Layer 目錄

# 1.2 階段二：Layer 資料處理
# 檢查今日是否有更新 docs/Extractor/
find docs/Extractor -name "*.md" -mtime -1 | wc -l
# 預期：應有大量今日更新的 .md 檔案

# 1.3 階段三：Mode 報告產出
PERIOD=$(date +%Y-%m)
WEEK=$(date +%Y-W%V)
ls docs/Narrator/market_snapshot/${WEEK}* 2>/dev/null | wc -l
ls docs/Narrator/ingredient_radar/${PERIOD}* 2>/dev/null | wc -l
ls docs/Narrator/topic_tracking/*/[0-9]*.md 2>/dev/null | wc -l
ls docs/Narrator/literature_review/*/[0-9]*.md 2>/dev/null | wc -l
# 預期：每個 Mode 都應有當期報告

# 1.4 階段三.5：選購指南交互作用更新
grep -l "交互作用\|Interaction" docs/reports/*/guide.md | wc -l
# 預期：應有多個 guide.md 包含交互作用章節

# 1.5 階段四：主題推薦
# 確認 recommend_topics.py 有執行（檢查輸出或 log）

# 1.6 階段五：Jekyll 轉換
ls docs/reports/*/reports/*.md 2>/dev/null | wc -l
ls docs/reports/*/literature/*.md 2>/dev/null | wc -l
# 預期：應有轉換後的報告檔案

# 1.7 階段五.5：SEO 驗證
python3 scripts/validate_seo.py 2>&1 | tail -5
# 預期：應顯示「通過」或無錯誤

# 1.8 階段六：部署與驗證
git log -1 --format="%H %s" | head -1
git status --short | wc -l
# 預期：最新 commit 應是今日，且 git status 為空
```

### 2. 連結檢查

```bash
# 檢查 GitHub Actions link-check 結果
gh run list --workflow="Deploy Documentation" --limit 1 --json conclusion | jq -r '.[0].conclusion'
# 預期：success
```

### 3. SEO 驗證

```bash
python3 scripts/validate_seo.py --verbose 2>&1 | grep -E "通過|失敗|錯誤|警告"
# 預期：顯示「通過」，無「錯誤」
```

### 4. Git 狀態檢查

```bash
# 4.1 所有變更已 commit
git status --short
# 預期：空輸出

# 4.2 已 push 到遠端
git log origin/main..HEAD --oneline
# 預期：空輸出（本地無未推送的 commit）

# 4.3 最新 commit 是今日
git log -1 --format="%ci" | cut -d' ' -f1
# 預期：今日日期
```

### 5. 網站內容驗證

使用 WebFetch 驗證以下頁面（至少抽查 3 個）：

| 頁面 | URL | 檢查項目 |
|------|-----|----------|
| 市場快照 | /reports/market-snapshot/{WEEK}.html | 產品數量正確 |
| 成分雷達 | /reports/ingredient-radar/{MONTH}.html | 報告內容完整 |
| 任一主題報告 | /reports/{topic}/reports/{MONTH}.html | 無「待補充」字樣 |

### 6. 主題報告完整性檢查

```bash
# 檢查所有主題是否完整
for topic in docs/reports/*/; do
  topic_name=$(basename "$topic")
  # 跳過非主題目錄
  [[ "$topic_name" == "market-snapshot" || "$topic_name" == "ingredient-radar" ]] && continue

  echo "=== $topic_name ==="
  [ -f "$topic/index.md" ] && echo "✅ index.md" || echo "❌ index.md"
  [ -f "$topic/guide.md" ] && echo "✅ guide.md" || echo "❌ guide.md"
  [ -d "$topic/reports" ] && echo "✅ reports/" || echo "❌ reports/"
  [ -d "$topic/literature" ] && echo "✅ literature/" || echo "❌ literature/"

  # 檢查交互作用章節
  if [ -f "$topic/guide.md" ]; then
    grep -q "交互作用\|Drug.*Interaction\|藥物.*交互" "$topic/guide.md" && \
      echo "✅ 交互作用" || echo "❌ 交互作用章節缺失"
  fi
done
```

## 輸出格式（必須遵守）

檢查完成後，輸出以下 JSON 格式：

```json
{
  "reviewer": "quality-gate",
  "timestamp": "2026-02-20T10:00:00+08:00",
  "verdict": "PASS|FAIL",
  "checks": [
    {"id": "sop-discovery", "name": "階段一：發現", "status": "PASS|FAIL", "detail": "..."},
    {"id": "sop-layer", "name": "階段二：Layer 處理", "status": "PASS|FAIL", "detail": "..."},
    {"id": "sop-mode", "name": "階段三：Mode 報告", "status": "PASS|FAIL", "detail": "..."},
    {"id": "sop-guide", "name": "階段三.5：交互作用更新", "status": "PASS|FAIL", "detail": "..."},
    {"id": "sop-recommend", "name": "階段四：主題推薦", "status": "PASS|FAIL", "detail": "..."},
    {"id": "sop-jekyll", "name": "階段五：Jekyll 轉換", "status": "PASS|FAIL", "detail": "..."},
    {"id": "sop-seo", "name": "階段五.5：SEO 驗證", "status": "PASS|FAIL", "detail": "..."},
    {"id": "sop-deploy", "name": "階段六：部署", "status": "PASS|FAIL", "detail": "..."},
    {"id": "link-check", "name": "連結檢查", "status": "PASS|FAIL", "detail": "..."},
    {"id": "git-status", "name": "Git 狀態", "status": "PASS|FAIL", "detail": "..."},
    {"id": "web-verify", "name": "網站驗證", "status": "PASS|FAIL", "detail": "..."},
    {"id": "topic-complete", "name": "主題完整性", "status": "PASS|FAIL", "detail": "..."}
  ],
  "failed_items": ["列出失敗項目的 id"],
  "summary": "12/12 通過" 或 "10/12 通過，2 項失敗"
}
```

## 判定規則

| 條件 | verdict |
|------|---------|
| 所有 checks 都是 PASS | PASS |
| 任何一個 check 是 FAIL | FAIL |

## FAIL 時的處理

如果 verdict = FAIL：

1. 列出所有失敗項目
2. 提供修正建議
3. 告知 Writer 需要修正後重新送審
4. **禁止回報「完成」**
```

---

## Writer 如何啟動 Reviewer

在「執行完整流程」的階段六完成後：

```python
Task(
  subagent_type: "general-purpose",
  model: "sonnet",
  run_in_background: false,  # 必須同步等待結果
  prompt: """
你是品質關卡 Reviewer。

請依據 prompt/任務完成品質關卡.md 的規格，執行所有驗證指令，
並以指定的 JSON 格式輸出檢查結果。

不要省略任何檢查項目。每個項目都必須執行對應的指令。
"""
)
```

---

## 與 CLAUDE.md 的整合

在 CLAUDE.md 的「階段七：任務完成品質關卡」章節中，加入：

```markdown
### 7.0 啟動 Reviewer 子代理（必做！）

⚠️ **禁止自我審核**：Writer 不能自己執行品質關卡檢查，必須啟動獨立的 Reviewer 子代理。

```python
# 啟動 Reviewer
reviewer_result = Task(
  subagent_type: "general-purpose",
  model: "sonnet",
  run_in_background: false,
  prompt: "讀取 prompt/任務完成品質關卡.md，執行所有驗證指令，輸出 JSON 格式結果"
)

# 解析結果
if reviewer_result.verdict == "PASS":
    # 可以回報完成
else:
    # 修正失敗項目後重新送審
```

### 7.1～7.6（由 Reviewer 執行，Writer 不需重複）

Writer 只需等待 Reviewer 結果，不需自己執行檢查。
```

---

## 檢查項目對照表

| 編號 | 檢查項目 | 驗證方式 | PASS 條件 |
|------|----------|----------|-----------|
| 1.1 | 階段一：發現 | ls Layers/ | 有 10 個有效 Layer |
| 1.2 | 階段二：Layer | find mtime -1 | 今日有更新 .md |
| 1.3 | 階段三：Mode | ls Narrator/ | 4 個 Mode 都有當期報告 |
| 1.4 | 階段三.5：交互 | grep guide.md | 有交互作用章節 |
| 1.5 | 階段四：推薦 | recommend_topics.py | 有執行（輸出推薦或無推薦）|
| 1.6 | 階段五：Jekyll | ls reports/ | 有轉換後的檔案 |
| 1.7 | 階段五.5：SEO | validate_seo.py | 無錯誤 |
| 1.8 | 階段六：部署 | git + gh run | push 成功 + Actions 綠燈 |
| 2 | 連結檢查 | gh run conclusion | success |
| 3 | SEO 驗證 | validate_seo.py | 通過 |
| 4 | Git 狀態 | git status | 乾淨 |
| 5 | 網站驗證 | WebFetch | 內容正確 |
| 6 | 主題完整性 | 腳本檢查 | 所有主題都有 4 個必要檔案 |

---

## 常見失敗原因與修正

| 失敗項目 | 常見原因 | 修正方式 |
|----------|----------|----------|
| sop-layer | 子代理未完成 | 等待或重新執行 |
| sop-mode | 報告未產出 | 重新執行 Mode 子代理 |
| sop-guide | 腳本未執行 | `python3 scripts/update_guide_interactions.py` |
| sop-jekyll | 轉換失敗 | `python3 scripts/convert_to_jekyll.py` |
| sop-seo | SEO 錯誤 | 依錯誤訊息修正 |
| sop-deploy | 未 push | `git push origin main` |
| link-check | 死連結 | 修正連結後重新部署 |
| git-status | 未 commit 的變更 | `git add . && git commit` |
| topic-complete | 缺少檔案 | 補齊缺失的 index/guide/reports/literature |

---

## 參考文件

- `/Users/lightman/weiqi.kids/agent.idea/seo/CLAUDE.md` - SEO + AEO 規則庫
- `/Users/lightman/weiqi.kids/agent.idea/seo/review/CLAUDE.md` - SEO Reviewer 檢查清單
